---
title: 'Redis 4.0 新功能：PSYNC 优化'
categories: 开源项目
tags: [Redis]
date: 2017-07-30
---

Redis 支持 Master-Slave（主从）模式，Redis Server 可以设置为另一个 Redis Server 的主机（从机），从机定期从主机拿数据。特殊的，一个从机同样可以设置为一个 Redis Server 的主机，如此形成 Redis Server 集群，无论是主机还是从机都是 Redis Server，都可以提供服务。在主机和从机之间需要同步数据，随着 Redis 版本的增加，同步机制也在不断发生变化。

### 全量同步
在 Redis 2.8 以前，Redis 只支持全量同步，分为同步（SYNC）和命令传播（COMMAND PROPAGATE）两个操作：
- 同步操作用于将从机的数据库状态更新至主机当前所处的数据库状态，具体实现主要是通过在主机执行 BGSAVE 命令生成 RDB 文件，在此之后的写命令存储到缓冲区
- 命令传播则用于在主机数据库状态被修改时，让主从数据库回到一致状态，具体实现主要是主机将自己执行的写命令发送给从机执行

对于初次复制来说，这样的同步机制可以很好地完成任务，但是对于断线后的复制而言，由于还是要进行全量复制，因此效率特别低下。主要耗时的原因在于 SYNC 命令：
- 主机需要执行 BGSAVE 命令生成 RDB 文件，耗费大量 CPU、内存和磁盘 I/O 资源
- 主机需要将生成的 RDB 文件发送给从服务器，耗费大量的带宽，导致服务响应时间变长
- 从机需要载入 RDB 文件导致阻塞

因此，优化同步机制的方向是尽量在有需要的时候才真正执行 SYNC 命令，而针对断线重连的情况，如果从机已经存有主机大量的数据，只是少部分数据没有的话，使用 SYNC 命令进行则非常浪费。

### PSYNC 机制
在 Redis 2.8 中引入了 PSYNC 机制，它的基础是：
- 主机和从机分别维护一个复制偏移量，通过对比主从机的复制偏移量，很容易判断是否处于一致状态；
- 主机维护一个复制积压缓冲区，存储一定数量的写命令
- 每个 Redis 服务器，都有自己的 runid，连接时，从机会获得主机的 runid

有了这些基础条件，可以按照如下的条件来判断是否需要全量同步：
- 从机保存的主机 runID 和当前主机的 runID 是否一致
- 从机维护的复制偏移量与主机的差值是否超过复制积压缓冲区里的命令个数

经过上述的判断，如果需要全量同步，则返回 +FULLRESYNC runid offset，否则返回 +CONTINUE 进行增量同步。
通过上述的优化，可以解决短时间的主从同步断线重连的问题，但是在如下的场景中，仍然需要全量同步：
- 主从机有重启过，因为 runid 重启后就会丢失，所以无法进行增量同步
- 从机被提升为主机，其它从机切换到新的主机需要全量同步，因为 新老主机的 runid 不同

### PSYNC 机制优化
为了解决主从角色切换导致的重新全量同步，Redis 4.0 引入一个新变量 replid2 来存放同步过的主机的 replid，replid 在主机的意义和之前 replid 仍然是一样的，但对于从机来说，replid 表示当前正在同步的主库的 replid 而不再是本身的 replid。replid2 则表示前一个主库的 replid，这个在主从角色切换的时候会用到。
同时，增加了一些主机判断是否允许进行增量同步的条件：
- 从机发送过来的 replid 是当前实例的 replid，说明之前就是这个实例的从库，或者
- 从机发送过来的 replid 是当前实例的 replid2，说明两者之前曾经属于同一个主机，而且两者的复制偏移量差距不能超过限制

```c
if (strcasecmp(master_replid, server.replid) &&
    (strcasecmp(master_replid, server.replid2) ||
        psync_offset > server.second_replid_offset)) {
    ...
    goto need_full_resync;
｝
```

此外，在做 RDB 备份的时候，replid、replid2 和 offset 会被持久化到 rdb 文件里面，这样即使服务重启了，也可以进行增量同步。
